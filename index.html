<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>서킷스토리 — GT7 트랙 추천기</title>
  <meta name="author" content="서킷스토리">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ff6b6b;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,Apple SD Gothic Neo,Malgun Gothic,"Noto Sans KR",sans-serif;background:linear-gradient(180deg,#07090b 0%,#0b1220 100%);color:#e6eef6}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 18px;color:var(--muted)}
    .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .selectors{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--glass);padding:12px;border-radius:10px;min-width:180px}
    .btn{background:linear-gradient(90deg,var(--accent),#ff9a68);border:none;padding:10px 14px;border-radius:8px;color:#081226;font-weight:700;cursor:pointer}
    .smallbtn{background:#0b2330;border-radius:8px;padding:6px 8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
    .results{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .trackGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;align-items:stretch}
    .track{background:#07101a;border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;justify-content:space-between;min-height:180px}
    .track h3{margin:0 0 6px;font-size:16px}
    .tag{display:inline-block;background:rgba(255,255,255,0.04);padding:6px;border-radius:6px;font-size:12px;margin-right:6px;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;user-select:none;outline:none}
    .pill:focus{box-shadow:0 0 0 3px rgba(159,208,255,0.12)}
    .pill.active{background:linear-gradient(90deg,var(--accent),#ff9a68);color:#061226;font-weight:700}
    .howto{background:#071a1a;padding:10px;border-radius:8px;margin-top:8px}
    .detail{background:#081422;padding:12px;border-radius:8px;margin-top:12px}
    .status{padding:8px;border-radius:8px;margin-bottom:8px}
    .status.ok{background:rgba(34,197,94,0.12);color:#9be6a8}
    .status.err{background:rgba(220,38,38,0.08);color:#ffb3b3}
    .groupHeader{font-weight:700}
    @media(max-width:600px){.selectors{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#081226,#0b3350);display:flex;align-items:center;justify-content:center;font-weight:700">GT7</div>
      <div style="flex:1">
        <h1>서킷스토리 — 트랙 추천기</h1>
        <p class="lead">QR 스캔 → 인원/스타일 선택 → 추천 트랙 & 플레이 가이드 제공. 손님이 직접 고르기 쉬운 페이지입니다.</p>
        <div id="statusBanner" class="status" aria-live="polite" style="display:none"></div>
      </div>
    </header>

    <section class="panel" aria-labelledby="step1">
      <h2 id="step1">1) 인원수를 선택하세요</h2>
      <div class="selectors" style="margin-top:12px">
        <label class="card"><input type="radio" name="people" value="solo" checked> 1인 (혼자)</label>
        <label class="card"><input type="radio" name="people" value="friends"> 2인 (친구)</label>
        <label class="card"><input type="radio" name="people" value="couple"> 2인 (커플)</label>
        <label class="card"><input type="radio" name="people" value="group"> 3인 이상 (단체)</label>
      </div>

      <h2 style="margin-top:16px">2) 원하는 플레이 스타일을 고르세요</h2>
      <div class="controls" id="modes" role="list">
        <div class="pill" data-mode="light" role="button" tabindex="0" aria-pressed="false">가벼운 드라이브 / 데이트</div>
        <div class="pill" data-mode="comp" role="button" tabindex="0" aria-pressed="false">경쟁 / 토너먼트</div>
        <div class="pill" data-mode="practice" role="button" tabindex="0" aria-pressed="false">연습 / 타임어택</div>
        <div class="pill" data-mode="party" role="button" tabindex="0" aria-pressed="false">파티 / 내구</div>
        <div class="pill" data-mode="offroad" role="button" tabindex="0" aria-pressed="false">오프로드 / 이색</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" id="go">추천 받기</button>
        <button class="smallbtn" id="shuffleBtn" title="다른 추천 보기">다른 추천 보기</button>
      </div>

      <div class="howto muted" style="margin-top:12px">사용법: 인원수와 플레이 스타일을 선택하면 <strong>추천 트랙 목록</strong>이 나옵니다. 트랙 카드의 <strong>간단 가이드</strong> 버튼을 눌러 자세한 진행 가이드를 확인하세요.</div>
    </section>

    <section class="panel" id="resultsSection" style="margin-top:12px; display:none">
      <h2>추천 트랙</h2>
      <div class="results" id="results">
        <div class="trackGrid" id="topPicks"></div>
        <div class="trackGrid" id="alternatePicks"></div>
        <div class="trackGrid" id="offroadPicks"></div>
        <div id="detailPanel" class="detail" style="display:none"></div>
      </div>
    </section>
  </div>

  <script>
    "use strict";

    function showStatus(message, ok=true){
      try{
        const el = document.getElementById("statusBanner");
        if(!el) return;
        el.style.display = "block";
        el.className = "status " + (ok? "ok" : "err");
        el.textContent = message;
      }catch(e){ console.error(e); }
    }

    function $all(sel){ try{ return Array.from(document.querySelectorAll(sel)); }catch(e){ return []; } }
    function $one(sel){ try{ return document.querySelector(sel); }catch(e){ return null; } }

    document.addEventListener("DOMContentLoaded", ()=>{
      try{
        const required = ["#go","#shuffleBtn","#topPicks","#alternatePicks","#offroadPicks","#detailPanel"];
        const missing = required.filter(s=>!$one(s));
        if(missing.length){ showStatus("초기화 실패: 요소 누락 - " + missing.join(", "), false); console.error("missing:", missing); return; }

        // === 데이터: 난이도 + 스노 코스 포함 ===
        const TRACKS = window.TRACKS_OVERRIDE || [
          {en:"24 Heures du Mans", ko:"르망 24시", region:"EU", tags:["group","friends"], modes:["엔듀런스","팀 릴레이"], difficulty:"medium", note:"긴 스트레이트 기반의 내구 레이스에 적합합니다."},
          {en:"Alsace (Original)", ko:"알자스", region:"EU", tags:["couple","solo"], modes:["드라이브","포토 세션"], difficulty:"easy", note:"풍경이 좋아 데이트용으로 추천합니다."},
          {en:"Autodrome Lago Maggiore", ko:"레이크 마조레 서킷", region:"EU", tags:["friends","solo"], modes:["토너먼트","세팅 연습"], difficulty:"medium", note:"다양한 레이아웃과 테크니컬 구간의 밸런스."},
          {en:"Interlagos", ko:"인터라고스", region:"SA", tags:["friends","group"], modes:["스프린트","토너먼트"], difficulty:"medium", note:"업다운과 백스트레이트가 조화로운 테크니컬 서킷."},
          {en:"Monza", ko:"몬차", region:"EU", tags:["friends","group"], modes:["스프린트","스피드 챌린지"], difficulty:"easy", note:"고속 위주의 단순 레이아웃."},
          {en:"Spa-Francorchamps", ko:"스파", region:"EU", tags:["friends","solo"], modes:["엔듀런스","타임어택"], difficulty:"hard", note:"고저차+고속 복합 코너. 전략성 요구."},
          {en:"Blue Moon Bay Speedway", ko:"블루 문 베이", region:"FI", tags:["group","friends"], modes:["릴레이","미니 토너먼트"], difficulty:"easy", note:"오벌 성격으로 쉬운 코너."},
          {en:"Broad Bean Raceway", ko:"브로드 빈", region:"FI", tags:["couple","friends"], modes:["체험","튜토리얼"], difficulty:"easy", note:"짧고 쉬워 초보·데이트에 적합."},
          {en:"Barcelona-Catalunya", ko:"바르셀로나", region:"EU", tags:["solo","friends"], modes:["연습","그리드 레이스"], difficulty:"medium", note:"균형형 코너 구성으로 연습 적합."},
          {en:"Barcelona-Catalunya (Autocross)", ko:"바르셀로나(오토크로스)", region:"EU", tags:["friends","offroad"], modes:["오프로드","이색"], difficulty:"medium", note:"짧고 기술적인 더트/그래블."},
          {en:"Goodwood", ko:"굿우드", region:"EU", tags:["couple","solo"], modes:["드라이브","포토"], difficulty:"easy", note:"클래식한 분위기, 낮은 난도."},
          {en:"Dragon Trail (Gardens)", ko:"드래곤 트레일(가든)", region:"FI", tags:["friends","group"], modes:["토너먼트","릴레이"], difficulty:"medium", note:"중속 추월 포인트 다수."},
          {en:"Fuji Speedway", ko:"후지 스피드웨이", region:"JP", tags:["friends","solo"], modes:["스프린트","세팅"], difficulty:"medium", note:"긴 직선+고속 브레이킹 연습."},
          {en:"Laguna Seca", ko:"라구나 세카", region:"US", tags:["solo","friends"], modes:["타임어택","그리드 레이스"], difficulty:"hard", note:"코크스크류 등 기술적 섹션."},
          {en:"Mount Panorama", ko:"마운트 파노라마", region:"AU", tags:["friends","solo"], modes:["엔듀런스","도전"], difficulty:"hard", note:"고저차 크고 협소한 구간."},
          {en:"Nürburgring Nordschleife", ko:"뉘르부르크링 노르트슐라이페", region:"EU", tags:["solo","friends"], modes:["타임어택","엔듀런스"], difficulty:"hard", note:"아주 긴 테크니컬 코스."},
          {en:"Special Stage Route X", ko:"스페셜 스테이지 루트 X", region:"FI", tags:["friends","solo","group"], modes:["스피드 챌린지","이색","타임어택"], difficulty:"easy", note:"초고속 오벌, 코너 난도 낮음."},
          {en:"Suzuka (Full)", ko:"스즈카", region:"JP", tags:["solo","friends"], modes:["타임어택","그리드 레이스"], difficulty:"hard", note:"S자 연속 고난도 코너."},
          {en:"Trial Mountain", ko:"트라이얼 마운틴", region:"FI", tags:["solo","couple"], modes:["연습","체험"], difficulty:"medium", note:"학습/연습에 좋은 밸런스."},
          {en:"Tsukuba", ko:"츠쿠바", region:"JP", tags:["solo","friends"], modes:["타임어택","스프린트"], difficulty:"medium", note:"짧고 기술적인 스프린트."},
          {en:"Deep Forest Raceway", ko:"딥 포레스트", region:"FI", tags:["solo","couple"], modes:["드라이브","타임어택"], difficulty:"medium", note:"경치+전통적 레이아웃."},
          {en:"Sardegna Road Track", ko:"사르데냐 로드 트랙", region:"EU", tags:["couple","group"], modes:["드라이브","테크니컬"], difficulty:"easy", note:"아스팔트 기반 로드 트랙."},
          {en:"Sardegna Windmills", ko:"사르데냐 윈드밀(비포장)", region:"EU", tags:["group","friends","offroad"], modes:["오프로드","릴레이"], difficulty:"medium", note:"언덕·모래·그래블 섞임."},
          {en:"Fisherman's Ranch", ko:"피셔맨스 랜치", region:"US", tags:["group","friends","offroad"], modes:["오프로드","드리프트"], difficulty:"medium", note:"험로 & 드리프트 친화."},
          {en:"Colorado Springs (Dirt)", ko:"콜로라도 스프링스 (더트)", region:"US", tags:["group","friends","offroad"], modes:["오프로드","이색"], difficulty:"hard", note:"랠리 스타일 고난도 더트."},
          {en:"Daytona", ko:"데이토나", region:"US", tags:["friends","group"], modes:["스프린트","스피드 챌린지"], difficulty:"easy", note:"오벌+로드 혼합, 쉬움."},
          {en:"Road Atlanta", ko:"로드 애틀랜타", region:"US", tags:["solo","friends"], modes:["타임어택","그리드 레이스"], difficulty:"medium", note:"중고속+테크니컬 조화."},
          {en:"Watkins Glen", ko:"왓킨스 글렌", region:"US", tags:["friends","solo"], modes:["그리드 레이스","타임어택"], difficulty:"medium", note:"플로우 좋은 연속 코너."},
          {en:"Willow Springs", ko:"윌로우 스프링스", region:"US", tags:["solo","friends"], modes:["스프린트","스피드 훈련"], difficulty:"medium", note:"빠른 섹션 위주."},
          {en:"High-Speed Ring", ko:"하이 스피드 링", region:"FI", tags:["friends","solo"], modes:["스피드 챌린지","타임어택"], difficulty:"easy", note:"가상의 초고속 트랙."},
          {en:"Lake Louise Short Track (Snow)", ko:"레이크 루이즈 숏 (스노우)", region:"CA", tags:["snow","offroad","friends","group"], modes:["오프로드","이색"], difficulty:"medium", note:"스노우 표면, 저마찰 코너링."},
          {en:"Lake Louise Long Track (Snow)", ko:"레이크 루이즈 롱 (스노우)", region:"CA", tags:["snow","offroad","group"], modes:["오프로드","이색","엔듀런스"], difficulty:"hard", note:"긴 랩, 눈길 브레이킹 관리."}
        ];

        // ===== 추가 특징(정확도 향상용). 일부만 지정하고 나머지는 기본값 사용
        const FEATURES = {
          "Monza": {lengthKm:5.8, cornerDensity:1, scenic:0, overtake:5},
          "Spa-Francorchamps": {lengthKm:7.0, cornerDensity:3, scenic:1, overtake:4},
          "Nürburgring Nordschleife": {lengthKm:20.8, cornerDensity:5, scenic:1, overtake:3},
          "Suzuka (Full)": {lengthKm:5.8, cornerDensity:4, scenic:0, overtake:3},
          "Tsukuba": {lengthKm:2.0, cornerDensity:3, scenic:0, overtake:3},
          "Laguna Seca": {lengthKm:3.6, cornerDensity:4, scenic:0, overtake:3},
          "Watkins Glen": {lengthKm:5.4, cornerDensity:3, scenic:0, overtake:4},
          "Fuji Speedway": {lengthKm:4.6, cornerDensity:2, scenic:1, overtake:4},
          "Mount Panorama": {lengthKm:6.2, cornerDensity:4, scenic:1, overtake:2},
          "Barcelona-Catalunya": {lengthKm:4.7, cornerDensity:3, scenic:0, overtake:3},
          "Daytona": {lengthKm:4.0, cornerDensity:1, scenic:0, overtake:5},
          "High-Speed Ring": {lengthKm:6.0, cornerDensity:1, scenic:0, overtake:4},
          "Blue Moon Bay Speedway": {lengthKm:2.6, cornerDensity:1, scenic:0, overtake:5},
          "Broad Bean Raceway": {lengthKm:1.9, cornerDensity:1, scenic:0, overtake:2},
          "Sardegna Windmills": {lengthKm:3.0, cornerDensity:3, scenic:0, overtake:3},
          "Fisherman's Ranch": {lengthKm:6.0, cornerDensity:3, scenic:0, overtake:3},
          "Colorado Springs (Dirt)": {lengthKm:3.5, cornerDensity:4, scenic:0, overtake:2},
          "Lake Louise Long Track (Snow)": {lengthKm:6.5, cornerDensity:3, scenic:1, overtake:2},
          "Lake Louise Short Track (Snow)": {lengthKm:3.0, cornerDensity:2, scenic:1, overtake:2}
        };

        const DIFF_ORDER = {easy:0, medium:1, hard:2};
        const MODE2LABEL = {light:"드라이브", comp:"토너먼트", practice:"타임어택", party:"엔듀런스"};
        const MODE2TARGET = {light:"easy", practice:"medium", comp:"hard", party:"easy"};

        const SURFACE = (t)=> (t.tags.includes('offroad') || t.tags.includes('snow'))? 'loose' : 'asphalt';
        const FEAT = (t)=> Object.assign({lengthKm:4.5, cornerDensity:3, scenic:0, overtake:3}, FEATURES[t.en]||{});

        function scoreTrack(t, people, modes){
          const f = FEAT(t);
          let score = 0;
          // 기본 적합도
          if(t.tags.includes(people)) score += 25;
          // 모드-레이아웃 적합성
          (modes||[]).forEach(m=>{
            const label = MODE2LABEL[m];
            if(label && t.modes.join(' ').includes(label)) score += 10;
          });
          // 난이도 타겟 근접도
          const targets = (modes||[]).filter(m=>m!=='offroad').map(m=>MODE2TARGET[m]).filter(Boolean);
          if(t.difficulty && DIFF_ORDER[t.difficulty] != null && targets.length){
            const dist = Math.min(...targets.map(trg=> Math.abs(DIFF_ORDER[t.difficulty]-DIFF_ORDER[trg])));
            score += (30 - 12*dist);
          }
          // 모드별 특성 보정
          if((modes||[]).includes('light')){ // 데이트/드라이브: 쉬움+경치+낮은 코너밀도
            score += (t.difficulty==='easy'?8:0) + (f.scenic?6:0) + (f.cornerDensity<=2?4:0);
          }
          if((modes||[]).includes('practice')){ // 연습/타임어택: 코너밀도 3~4 선호
            score += (f.cornerDensity===3?6:0) + (f.cornerDensity===4?4:0);
          }
          if((modes||[]).includes('comp')){ // 경쟁: 추월 용이, 중~장거리, 쉬움 패널티
            score += (f.overtake>=4?8:0) + (f.lengthKm>=4.5?4:0);
            if(t.difficulty==='easy') score -= 6;
          }
          if((modes||[]).includes('party')){ // 파티/내구: 쉬움/중간 난이도, 중거리 이상 선호
            score += (t.difficulty!=='hard'?4:0) + (f.lengthKm>=4?3:0);
          }
          // 페널티
          if((modes||[]).includes('light') && t.difficulty==='hard') score -= 10;
          return score;
        }

        // 다양성 강제: 유사한 항목에 감점(MMR 유사)
        function diversify(sorted, k){
          const picked = [];
          const sim = (a,b)=>{
            let s = 0;
            if(a.region===b.region) s += 0.35;
            if(a.difficulty===b.difficulty) s += 0.25;
            if(SURFACE(a)===SURFACE(b)) s += 0.25;
            const la = FEAT(a).lengthKm, lb = FEAT(b).lengthKm; s += (Math.abs(la-lb)<=1?0.15:0);
            return s; // 0~1
          };
          const penalize = (cand)=> picked.reduce((pen, p)=> pen + sim(cand,p)*12, 0);
          const pool = sorted.slice();
          while(pool.length && picked.length<k){
            // 매 라운드마다 페널티 반영 점수로 최대값 선택
            let bestIdx = 0, bestVal = -Infinity;
            for(let i=0;i<pool.length;i++){
              const base = pool[i]._score;
              const pv = base - penalize(pool[i]);
              if(pv>bestVal){ bestVal = pv; bestIdx = i; }
            }
            picked.push(pool.splice(bestIdx,1)[0]);
          }
          return picked;
        }

        // 헬퍼: 오프로드 후보군 (offroad+snow) — 인원 매칭, 쉬운 난이도 우선
        function getOffroadCandidates(people, modes){
          const list = TRACKS.filter(t=> (t.tags.includes('offroad') || t.tags.includes('snow')) && t.tags.includes(people));
          return list
            .map(t=> Object.assign({_score: scoreTrack(t, people, modes)}, t))
            .sort((a,b)=> b._score - a._score);
        }

        // 메인 필터: "오프로드/이색 미선택이면 비포장/스노우 노출 금지"
        function computeMainCandidates(people, modes){
          // 아스팔트만
          const base = TRACKS.filter(t=> !t.tags.includes('offroad') && !t.tags.includes('snow') && t.tags.includes(people));
          // 점수 부여
          const scored = base.map(t=> Object.assign({_score: scoreTrack(t,people,modes)}, t));
          // 점수로 1차 정렬
          scored.sort((a,b)=> b._score - a._score);
          return scored;
        }

        // ===== UI 요소 참조
        const topPicksEl = $one('#topPicks');
        const altPicksEl = $one('#alternatePicks');
        const offPicksEl = $one('#offroadPicks');
        const detailPanel = $one('#detailPanel');
        const goBtn = $one('#go');
        const shuffleBtn = $one('#shuffleBtn');

        // 모드 토글(접근성 포함)
        const modesContainer = $one('#modes');
        function togglePill(p){ const active = p.classList.toggle('active'); p.setAttribute('aria-pressed', active? 'true':'false'); }
        if(modesContainer){
          modesContainer.addEventListener('click', (e)=>{ const p = e.target.closest && e.target.closest('.pill'); if(p) togglePill(p); });
          modesContainer.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ const p=e.target.closest&&e.target.closest('.pill'); if(p){ e.preventDefault(); togglePill(p); } }});
          $all('.pill').forEach(p=>{ p.setAttribute('role','button'); p.setAttribute('tabindex','0'); p.setAttribute('aria-pressed','false'); });
        }

        function renderGrid(list, container, title){
          try{
            const header = document.createElement('div'); header.className='groupHeader muted'; header.style.margin='6px 0 12px'; header.style.gridColumn = '1 / -1'; header.textContent = title; container.appendChild(header);
            list.forEach(t=>{
              const div = document.createElement('div'); div.className = 'track';
              const h = document.createElement('h3'); h.textContent = `${t.ko} — ${t.en}`; div.appendChild(h);
              const diffLabel = {easy:'쉬움', medium:'보통', hard:'어려움'}[t.difficulty||'medium'];
              const surfaceLabel = SURFACE(t)==='loose'? '오프로드/스노우':'아스팔트';
              const tags = document.createElement('div'); tags.innerHTML = `<span class=\"tag\">추천: ${t.tags.join(', ')}</span> <span class=\"tag\">권장모드: ${t.modes.join(', ')}</span> <span class=\"tag\">코너 난이도: ${diffLabel}</span> <span class=\"tag\">노면: ${surfaceLabel}</span>`; div.appendChild(tags);
              const p = document.createElement('p'); p.className='muted small'; p.textContent = t.note; div.appendChild(p);
              const btnWrap = document.createElement('div'); btnWrap.style.marginTop='8px';
              const infoBtn = document.createElement('button'); infoBtn.className='smallbtn'; infoBtn.style.marginLeft='8px'; infoBtn.textContent='간단 가이드';
              infoBtn.addEventListener('click', ()=> showDetail(t)); btnWrap.appendChild(infoBtn);
              div.appendChild(btnWrap); container.appendChild(div);
            });
          }catch(e){ console.error('renderGrid failed', e); }
        }

        function generateTrackTips(t){
          try{
            const name = (t.en || '').toLowerCase();
            const koName = (t.ko || '').toLowerCase();
            if(name.includes('special stage route x') || name.includes('special stage') || koName.includes('스페셜')){
              return ''+
                '<li>초고속 오벌: 드래프팅 타이밍이 핵심.</li>'+
                '<li>다운포스↓, 고속 기어비로 최고속 확보.</li>'+
                '<li>브레이크·타이어 온도 관리.</li>';
            }
            if(name.includes('suzuka')) return '<li>스즈카: S자 리듬 유지, 진입 속도 과도 금지.</li>';
            if(name.includes('nürburgring') || name.includes('nordschleife')) return '<li>뉘르부르크링: 섹터별 목표로 분할 정복.</li>';
            if(name.includes('spa')) return '<li>스파: Eau Rouge 전 속도조절, 라인 정확도 우선.</li>';
            if(name.includes('mount panorama')) return '<li>바서스트: 다운힐 브레이크 온도·라인 관리.</li>';
            if(name.includes('laguna')) return '<li>라구나 세카: 코크스크류 진입 전 차량 안정화.</li>';
            if(t.tags && (t.tags.includes('offroad') || t.tags.includes('snow'))) return '<li>저마찰 노면: 브레이크는 직진에서, 스로틀은 짧게.</li>';
            return '<li>일반 팁: 한 요소씩 개선(브레이크/진입/출구).</li>';
          }catch(e){ console.error('generateTrackTips failed', e); return '<li>팁을 불러오는 중 오류가 발생했습니다.</li>'; }
        }

        function showDetail(track){
          try{
            const people = $one('input[name="people"]:checked')?.value || 'solo';
            const modes = $all('.pill').filter(x=>x.classList.contains('active')).map(x=>x.dataset.mode);
            detailPanel.style.display = 'block';
            const lines = [];
            lines.push(`<h3 style=\"margin-top:0\">${track.ko} — ${track.en}</h3>`);
            lines.push(`<p class=\"muted\">추천 모드: ${track.modes.join('/')} · 선택 스타일: ${(modes&&modes.join(', ')||'일반')} · 코너 난이도: ${(track.difficulty||'N/A')}</p>`);
            lines.push('<h4>사전 준비(3분)</h4>');
            lines.push('<ol><li>휠/패달 캘리브레이션 확인</li><li>차종/어시스트 고정</li><li>타이어·연료 초기값 확인</li></ol>');
            lines.push('<h4>트랙 팁</h4>');
            lines.push('<ul>'+generateTrackTips(track)+'</ul>');
            detailPanel.innerHTML = lines.join('\n');
            detailPanel.scrollIntoView({behavior:'smooth', block:'center'});
          }catch(e){ console.error('showDetail failed', e); }
        }

        function shuffleArray(a){ const arr = a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

        function renderRecommendations(shuffle=false){
          try{
            const people = $one('input[name="people"]:checked')?.value || 'solo';
            const modes = $all('.pill').filter(x=>x.classList.contains('active')).map(x=>x.dataset.mode);
            const isOff = modes.includes('offroad');
            const isExclusiveOff = isOff && modes.length===1;

            // 메인(아스팔트) 후보 계산 → 다양성 적용
            let mainScored = computeMainCandidates(people, modes);
            if(shuffle){ // 셔플은 약간의 난수 가중치로 순위 흔들기
              mainScored = mainScored.map(t=> Object.assign({}, t, {_score: t._score + (Math.random()*4-2)}));
              mainScored.sort((a,b)=> b._score - a._score);
            }
            const mainTop = diversify(mainScored, 6);
            const top = mainTop.slice(0,3);
            const alt = mainTop.slice(3,6);

            // 오프로드 섹션 (선택 시에만)
            const offList = isOff ? diversify(getOffroadCandidates(people, modes), 6) : [];

            $one('#resultsSection').style.display = 'block';
            topPicksEl.innerHTML = ''; altPicksEl.innerHTML = ''; offPicksEl.innerHTML = ''; detailPanel.style.display = 'none';
            if(top.length){ renderGrid(top, topPicksEl, '추천 트랙 — Top Picks'); }
            if(alt.length){ renderGrid(alt, altPicksEl, '대체 추천 — Alternate Picks'); }
            if(offList.length){ renderGrid(offList, offPicksEl, '오프로드/스노우 — Offroad & Snow Picks'); }
            if(!top.length && !alt.length && !offList.length){ topPicksEl.innerHTML = '<div class="muted">조건에 맞는 트랙이 없습니다. 다른 옵션을 선택해보세요.</div>'; }
            showStatus('정상: 추천 목록이 갱신되었습니다.', true);
          }catch(e){ console.error('renderRecommendations failed', e); showStatus('추천 생성 중 오류가 발생했습니다. 콘솔을 확인하세요.', false); }
        }

        // 이벤트 바인딩
        goBtn.addEventListener('click', ()=> renderRecommendations());
        shuffleBtn.addEventListener('click', ()=> renderRecommendations(true));

        // ========= 테스트 하네스 (정확도+다양성) =========
        (function runTests(){
          const R = [];
          function t(name, fn){ try{ R.push({name, ok: !!fn()}); } catch(e){ R.push({name, ok:false, err:String(e)}); } }

          // 기존 정책 회귀 방지
          t('exclusive offroad => only offroad/snow', ()=>{
            const out = getOffroadCandidates('friends', ['offroad']);
            return out.length>0 && out.every(x=> x.tags.includes('offroad') || x.tags.includes('snow'));
          });
          t('no offroad selected => excludes offroad/snow in main', ()=>{
            const out = computeMainCandidates('friends', ['light']);
            return out.every(x=> !x.tags.includes('offroad') && !x.tags.includes('snow'));
          });

          // 정확도: Light 상단에서 hard가 과점 금지(가능하면 easy/medium 우선)
          t('light mode prefers easy in top', ()=>{
            const out = diversify(computeMainCandidates('couple', ['light']), 3);
            const diffs = out.map(x=>x.difficulty);
            return diffs.includes('easy') || diffs.every(d=> d!=='hard');
          });

          // 정확도: Comp 상단에서 easy 배제(대안이 있을 때)
          t('comp mode discourages easy in top1', ()=>{
            const out = diversify(computeMainCandidates('friends', ['comp']), 1);
            return out.length===0 || out[0].difficulty!=='easy';
          });

          // 다양성: 상위 3개가 같은 지역/난이도로만 꽉 차지 않음(가능한 경우)
          t('diversity in top3 when available', ()=>{
            const out = diversify(computeMainCandidates('friends', ['practice']), 3);
            const regions = new Set(out.map(x=>x.region));
            const diffs = new Set(out.map(x=>x.difficulty));
            return regions.size>=2 || diffs.size>=2;
          });

          const pass = R.filter(r=>r.ok).length;
          const fail = R.length - pass;
          console.group('[GT7 Tests]');
          R.forEach(r=> console[r.ok?'log':'error']((r.ok?'✅':'❌')+' '+r.name, r.err? (' — '+r.err):''));
          console.groupEnd();
          showStatus(`자검사 완료: ${pass} 통과 / ${fail} 실패`, fail===0);
        })();

      }catch(e){ console.error('Initialization failed', e); showStatus('초기화 중 예외가 발생했습니다. 콘솔을 확인하세요.', false); }
    });
  </script>
</body>
</html>
